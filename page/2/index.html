<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="aiping.liang s home">
<meta property="og:type" content="website">
<meta property="og:title" content="Aiping.LAP">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Aiping.LAP">
<meta property="og:description" content="aiping.liang s home">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aiping.LAP">
<meta name="twitter:description" content="aiping.liang s home">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Aiping.LAP</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Aiping.LAP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">认真工作，快乐生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/23/java基础面试之Consumer-Producer模型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/09/23/java基础面试之Consumer-Producer模型/" itemprop="url">java基础面试之Consumer-Producer模型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-09-22T19:22:35-08:00">
                2015-09-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h1><p>近来用到了很多生产者和消费者模型来做一些开发和面试，所以有感而发，记录一些知识。</p>
<p>生产者-消费者模型是一个常用的异步线程的处理模型。简单点讲，主要分3个部分，生产者，消费者，锁。</p>
<p>生产者： 创造一些资源，可以是任何资源，比如从文件中读出的某一行</p>
<p>消费者：  合理的利用生产者生成的资源完成自己的需求</p>
<p>锁：提供一个异步的控制器，保证在生产着没有生成资源的时候，消费着无法消费</p>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><p>下面就以读取一个文件为例子来描述这个模型</p>
<h2 id="producer"><a href="#producer" class="headerlink" title="producer"></a>producer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by aiping.lap on 15/09/21.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> aiping.lap</div><div class="line"> * <span class="doctag">@date</span> 2015/09/21</div><div class="line"> */</div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileReader;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateRowKey</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="comment">//调用锁类，主要是把生成的资源扔到该锁中</span></div><div class="line">    <span class="keyword">private</span> GetRandmKey getRandmKey;</div><div class="line">    <span class="comment">//产生资源的文件，文件中的每行即一个资源</span></div><div class="line">    <span class="keyword">private</span> String rowKeyFile;</div><div class="line">    <span class="comment">//临时存储从文件中读出的行</span></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; keyList = <span class="keyword">new</span> ArrayList();</div><div class="line">    <span class="comment">//临时存储的最小值</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> MIN = <span class="number">5000</span>;</div><div class="line">    <span class="comment">//临时存储的最大值</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> MAX = <span class="number">10000</span>;</div><div class="line">    <span class="comment">//删除的值</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> getIndex = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> FileReader fReader = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">public</span> BufferedReader bf = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isEnd = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CreateRowKey</span><span class="params">(GetRandmKey GetRandmKey, String rowKeyFile)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.getRandmKey = GetRandmKey;</div><div class="line">        <span class="keyword">this</span>.rowKeyFile = rowKeyFile;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//异步的线程类读取文件，如果内存中，存数的量小于总量的一半的时候，就去读取文件，直到临时存储区的条数到达最大值</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetkeyFromFile</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> String rowKey;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"Start to get row from file to memory!"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (keyList.size() &lt;= MAX) &#123;</div><div class="line">                    <span class="keyword">if</span> (fReader == <span class="keyword">null</span>)&#123;</div><div class="line">                        fReader = <span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(rowKeyFile));</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (bf == <span class="keyword">null</span>)&#123;</div><div class="line">                        bf = <span class="keyword">new</span> BufferedReader(fReader);</div><div class="line">                    &#125;</div><div class="line">                    rowKey = bf.readLine();</div><div class="line">                    <span class="keyword">if</span> (rowKey == <span class="string">""</span> || rowKey == <span class="keyword">null</span>)&#123;</div><div class="line">                        System.out.println(<span class="string">"File is read end!"</span>);</div><div class="line">                        isEnd = <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        keyList.add(rowKey);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                System.out.println(e);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    bf.close();</div><div class="line">                    fReader.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    <span class="comment">// TODO Auto-generated catch block</span></div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"End to get row from file to memory!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">boolean</span> isRead = <span class="keyword">true</span>;</div><div class="line">        System.out.println(<span class="string">"Start to create key!"</span>);</div><div class="line">        <span class="keyword">while</span> (isRead)&#123;</div><div class="line"></div><div class="line">            <span class="comment">//如果文件已经读完且已经消费完，则退出</span></div><div class="line">            <span class="keyword">if</span> (isEnd &amp;&amp; keyList.isEmpty())&#123;</div><div class="line">                System.out.println(<span class="string">"Read to end!"</span>);</div><div class="line">                isRead = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//如果没有读完，则启动异步的线程去读取</span></div><div class="line">            <span class="keyword">if</span> (keyList.size() &lt; MIN &amp;&amp; !isEnd )&#123;</div><div class="line">                System.out.println(<span class="string">"Start to update memory!"</span>);</div><div class="line">                GetkeyFromFile getkeyFromFile = <span class="keyword">new</span> GetkeyFromFile();</div><div class="line">                getkeyFromFile.start();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//如果列表中不为空，则从中获取相应的值</span></div><div class="line">            <span class="keyword">if</span> (!keyList.isEmpty() )&#123;</div><div class="line">                getRandmKey.createRowKey(keyList.get(getIndex));</div><div class="line">                keyList.remove(getIndex);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    sleep(<span class="number">5000</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    <span class="comment">// TODO Auto-generated catch block</span></div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="consumer类"><a href="#consumer类" class="headerlink" title="consumer类"></a>consumer类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by aiping.lap on 15/09/21.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> aiping.lap</div><div class="line"> * <span class="doctag">@date</span> 2015/09/21</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> GetRandmKey getRandmKey;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">( GetRandmKey getRandmKey)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.getRandmKey =   getRandmKey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 从锁类中读取相应的资源</span></div><div class="line">        <span class="keyword">while</span>  (<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            System.out.printf(<span class="string">"The consumer get the product %d #\n"</span>,getRandmKey.getRowKey());</div><div class="line">            <span class="keyword">try</span></div><div class="line">            &#123;</div><div class="line">                sleep((<span class="keyword">int</span>)(Math.random() * <span class="number">100</span> ));</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e)</div><div class="line">            &#123;</div><div class="line">                System.out.println(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="锁类"><a href="#锁类" class="headerlink" title="锁类"></a>锁类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by aiping.lap on 15/09/21.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> aiping.lap</div><div class="line"> * <span class="doctag">@date</span> 2015/09/21</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetRandmKey</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String rowkey;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isReady = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//对象锁保证对于同一个资源，只能由一个消费者获取</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">getRowKey</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">while</span> (isReady == <span class="keyword">false</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                System.out.println(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        isReady = <span class="keyword">false</span>;</div><div class="line">        notifyAll();</div><div class="line">        <span class="keyword">return</span> rowkey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//保证同时只有一个生产者可以产生资源</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">createRowKey</span><span class="params">(String rowkey)</span></span>&#123;</div><div class="line">        <span class="keyword">while</span> (isReady) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                System.out.println(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.rowkey = rowkey;</div><div class="line">        isReady = <span class="keyword">true</span>;</div><div class="line">        notifyAll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="main类"><a href="#main类" class="headerlink" title="main类"></a>main类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//生成共享的锁</span></div><div class="line">    GetRandmKey getRandmKey = <span class="keyword">new</span> GetRandmKey();</div><div class="line">    <span class="comment">//创建生产者</span></div><div class="line">    CreateRowKey createRowKey = <span class="keyword">new</span> CreateRowKey(getRandmKey,<span class="string">"filename"</span>);</div><div class="line">    <span class="comment">//创建消费者</span></div><div class="line">    Consumer consumer = <span class="keyword">new</span> Consumer(getRandmKey);</div><div class="line">    createRowKey.start();</div><div class="line">    consumer.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这个简单的模型中，可以看到一个最为朴素的异步思想，资源的生成者不关心是否有消费者，只需要生成相应的资源即可。而对于消费者，只需要从固定的地方取资源，不需要关心资源从哪里来。通过锁类完美的解决了数据一致性的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/07/记录一次HBase的问题排查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/07/记录一次HBase的问题排查/" itemprop="url">记录一次HBase的问题排查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-04-06T19:22:14-08:00">
                2015-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h1><p>所有的region被卡死，无法打开，访问缓慢</p>
<h1 id="问题跟踪"><a href="#问题跟踪" class="headerlink" title="问题跟踪"></a>问题跟踪</h1><p>老实说，这个现象很常见，有时候是因为压力太大，有时候因为别的原因，所以我这里的跟进方法是一般的一个方法，但是不能解决所有问题，具体问题需要具体分析。</p>
<h1 id="1、找到有问题的region"><a href="#1、找到有问题的region" class="headerlink" title="1、找到有问题的region"></a>1、找到有问题的region</h1><p>这个方法比较多，一般来说可以根据请求慢的key，以及通过管理页面，定位到确定的出问题的Region，一个形如0313e59d82326803c21470f5c25fef79的串</p>
<h2 id="2、查找出问题region所在的物理机"><a href="#2、查找出问题region所在的物理机" class="headerlink" title="2、查找出问题region所在的物理机"></a>2、查找出问题region所在的物理机</h2><p>从管理页面上看到的region分布不一定是正确的分布，因为中间可能发生过迁移，所以最稳妥的方法是去Master上搜索所有和这个region相关的日志，查找出问题时间段这个region应该所处的节点，例如发现如下日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2015</span>-<span class="number">04</span>-<span class="number">05</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">49</span>,<span class="number">257</span> INFO org.apache.hadoop.hbase.master.AssignmentManager: Server bjlg-<span class="number">48</span>p28-hadoop18.bfdabc.com,<span class="number">60020</span>,<span class="number">1420985184893</span> returned java.net.SocketTimeoutException: Call to [bjlg-<span class="number">48</span>p28-hadoop18.bfdabc.com/<span class="number">192.168</span>.48.28:<span class="number">60020</span>](http:<span class="comment">//bjlg-48p28-hadoop18.bfdabc.com/192.168.48.28:60020) failed on socket timeout exception: java.net.SocketTimeoutException: 20000 millis timeout while waiting for channel to be ready for connect. ch : java.nio.channels.SocketChannel[connection-pending remote=[bjlg-48p28-hadoop18.bfdabc.com/192.168.48.28:60020](http://bjlg-48p28-hadoop18.bfdabc.com/192.168.48.28:60020)] for 0313e59d82326803c21470f5c25fef79</span></div></pre></td></tr></table></figure>
<h2 id="3、到相关的节点上进一步排查"><a href="#3、到相关的节点上进一步排查" class="headerlink" title="3、到相关的节点上进一步排查"></a>3、到相关的节点上进一步排查</h2><p>一般来说，先从机器的load，或者磁盘使用率、cpu使用率、内存状况等开始入手排查，这些基本的我都跳过了，直接说一个我们的问题：查看regionserver的进程，发现了一个死锁</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># Found one Java-level deadlock:</div><div class="line"></div><div class="line">"IPC Server handler 39 on 60020":</div><div class="line">waiting to lock monitor 0x00002aaac9c5b838 (object 0x000000058cacc9b8, a java.lang.Object),</div><div class="line">which is held by "regionserver60020.logRoller"</div><div class="line">"regionserver60020.logRoller":</div><div class="line">waiting to lock monitor 0x00002aaac981f4d0 (object 0x000000058cacc9d0, a java.lang.Object),</div><div class="line">which is held by "IPC Server handler 37 on 60020"</div><div class="line">"IPC Server handler 37 on 60020":</div><div class="line">waiting to lock monitor 0x00002aaac9c5b838 (object 0x000000058cacc9b8, a java.lang.Object),</div><div class="line">which is held by "regionserver60020.logRoller"</div></pre></td></tr></table></figure>
<h2 id="4、跟踪死锁的进程："><a href="#4、跟踪死锁的进程：" class="headerlink" title="4、跟踪死锁的进程："></a>4、跟踪死锁的进程：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="string">"IPC Server handler 39 on 60020"</span>:</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.append(HLog.[java:<span class="number">1122</span>](http:<span class="comment">//java:1122/))</span></div><div class="line">\- waiting to lock &lt;<span class="number">0x000000058cacc9b8</span>&gt; (a java.lang.Object)</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.appendNoSync(HLog.[java:<span class="number">1168</span>](http:<span class="comment">//java:1168/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegion.doMiniBatchMutation(HRegion.[java:<span class="number">2225</span>](http:<span class="comment">//java:2225/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.[java:<span class="number">1973</span>](http:<span class="comment">//java:1973/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegionServer.multi(HRegionServer.[java:<span class="number">3492</span>](http:<span class="comment">//java:3492/))</span></div><div class="line">at sun.reflect.GeneratedMethodAccessor38.invoke(Unknown Source)</div><div class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">25</span>)</div><div class="line">at java.lang.reflect.Method.invoke(Method.[java:<span class="number">597</span>](http:<span class="comment">//java:597/))</span></div><div class="line">at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.[java:<span class="number">364</span>](http:<span class="comment">//java:364/))</span></div><div class="line">at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.[java:<span class="number">1426</span>](http:<span class="comment">//java:1426/))</span></div><div class="line"><span class="string">"regionserver60020.logRoller"</span>:</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.syncer(HLog.[java:<span class="number">1302</span>](http:<span class="comment">//java:1302/))</span></div><div class="line">\- waiting to lock &lt;<span class="number">0x000000058cacc9d0</span>&gt; (a java.lang.Object)</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.syncer(HLog.[java:<span class="number">1280</span>](http:<span class="comment">//java:1280/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.sync(HLog.[java:<span class="number">1433</span>](http:<span class="comment">//java:1433/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.cleanupCurrentWriter(HLog.[java:<span class="number">866</span>](http:<span class="comment">//java:866/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.rollWriter(HLog.[java:<span class="number">640</span>](http:<span class="comment">//java:640/))</span></div><div class="line">\- locked &lt;<span class="number">0x000000058cacc9b8</span>&gt; (a java.lang.Object)</div><div class="line">at org.apache.hadoop.hbase.regionserver.LogRoller.run(LogRoller.java:<span class="number">94</span>)</div><div class="line">at java.lang.Thread.run(Thread.[java:<span class="number">662</span>](http:<span class="comment">//java:662/))</span></div><div class="line"><span class="string">"IPC Server handler 37 on 60020"</span>:</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.syncer(HLog.[java:<span class="number">1311</span>](http:<span class="comment">//java:1311/))</span></div><div class="line">\- waiting to lock &lt;<span class="number">0x000000058cacc9b8</span>&gt; (a java.lang.Object)</div><div class="line">\- locked &lt;<span class="number">0x000000058cacc9d0</span>&gt; (a java.lang.Object)</div><div class="line">at org.apache.hadoop.hbase.regionserver.wal.HLog.sync(HLog.[java:<span class="number">1437</span>](http:<span class="comment">//java:1437/))</span></div><div class="line"></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegion.syncOrDefer(HRegion.[java:<span class="number">5205</span>](http:<span class="comment">//java:5205/))</span></div><div class="line"></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegion.doMiniBatchMutation(HRegion.[java:<span class="number">2245</span>](http:<span class="comment">//java:2245/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.[java:<span class="number">1973</span>](http:<span class="comment">//java:1973/))</span></div><div class="line">at org.apache.hadoop.hbase.regionserver.HRegionServer.multi(HRegionServer.[java:<span class="number">3492</span>](http:<span class="comment">//java:3492/))</span></div><div class="line">at sun.reflect.GeneratedMethodAccessor38.invoke(Unknown Source)</div><div class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">25</span>)</div><div class="line">at java.lang.reflect.Method.invoke(Method.[java:<span class="number">597</span>](http:<span class="comment">//java:597/))</span></div><div class="line">at org.apache.hadoop.hbase.ipc.WritableRpcEngine$Server.call(WritableRpcEngine.[java:<span class="number">364</span>](http:<span class="comment">//java:364/))</span></div><div class="line">at org.apache.hadoop.hbase.ipc.HBaseServer$Handler.run(HBaseServer.[java:<span class="number">1426</span>](http:<span class="comment">//java:1426/))</span></div></pre></td></tr></table></figure>
<h2 id="5、分析"><a href="#5、分析" class="headerlink" title="5、分析"></a>5、分析</h2><p>最后确定这是logRoller和HLog.syncer两个线程发生了死锁。</p>
<p>在HBase，采用WAL(Write Ahead Log)的方式来保证数据不丢失。一个Region Server对应一个HLog，任何数据都是先写HLog，然后才真正的写MemStore。HLog文件有个轮转的过程，当达到默认大小（一般是block size * 0.95）就会写一个新的HLog文件，logRoller线程就是做这个事情的。而buffer中的数据每隔一秒钟会写一次HLog文件，这个是HLog.syncer线程负责的。logRoller和HLog.syncer进程不能同时进行，不然会导致数据问题，于是就需要通过锁来进行互斥了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">append</span><span class="params">(HRegionInfo info, <span class="keyword">byte</span> [] tableName, WALEdit edits, UUID clusterId,</span></span></div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">long</span> now, HTableDescriptor htd, <span class="keyword">boolean</span> doSync)</div><div class="line"></div><div class="line"><span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (edits.isEmpty())</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.unflushedEntries.get();</div><div class="line">    ;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.closed) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Cannot append; log is closed"</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">long</span> txid = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.updateLock) &#123; <span class="comment">//在追加Hlog文件的时候，需要获取到文件的锁</span></div><div class="line"></div><div class="line">        <span class="keyword">long</span> seqNum = obtainSeqNum();</div><div class="line"></div><div class="line">        <span class="comment">// The 'lastSeqWritten' map holds the sequence number of the oldest</span></div><div class="line"></div><div class="line">        <span class="comment">// write for each region (i.e. the first edit added to the particular</span></div><div class="line"></div><div class="line">        <span class="comment">// memstore). . When the cache is flushed, the entry for the</span></div><div class="line"></div><div class="line">        <span class="comment">// region being flushed is removed if the sequence number of the flush</span></div><div class="line"></div><div class="line">        <span class="comment">// is greater than or equal to the value in lastSeqWritten.</span></div><div class="line"></div><div class="line">        <span class="comment">// Use encoded name.  Its shorter, guaranteed unique and a subset of</span></div><div class="line"></div><div class="line">        <span class="comment">// actual  name.</span></div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] encodedRegionName = info.getEncodedNameAsBytes();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.lastSeqWritten.putIfAbsent(encodedRegionName, seqNum);</div><div class="line"></div><div class="line">        HLogKey logKey = makeKey(encodedRegionName, tableName, seqNum, now, clusterId);</div><div class="line"></div><div class="line">        doWrite(info, logKey, edits, htd);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.numEntries.incrementAndGet();</div><div class="line"></div><div class="line">        txid = <span class="keyword">this</span>.unflushedEntries.incrementAndGet();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (htd.isDeferredLogFlush()) &#123;</div><div class="line"></div><div class="line">            lastDeferredTxid = txid;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> doneUpto;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// First flush all the pending writes to HDFS. Then</span></div><div class="line"></div><div class="line">        <span class="comment">// issue the sync to HDFS. If sync is successful, then update</span></div><div class="line"></div><div class="line">        <span class="comment">// syncedTillHere to indicate that transactions till this</span></div><div class="line"></div><div class="line">        <span class="comment">// number has been successfully synced.</span></div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (flushLock) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (txid &lt;= <span class="keyword">this</span>.syncedTillHere) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">return</span>;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            doneUpto = <span class="keyword">this</span>.unflushedEntries.get();</div><div class="line"></div><div class="line">            List pending = logSyncerThread.getPendingWrites();</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">                logSyncerThread.hlogFlush(tempWriter, pending);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (IOException io) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>.updateLock) &#123; <span class="comment">//当hlogFlush发生exception的时候发生了死锁</span></div><div class="line"></div><div class="line">                    <span class="comment">// HBASE-4387, HBASE-5623, retry with updateLock held</span></div><div class="line"></div><div class="line">                    tempWriter = <span class="keyword">this</span>.writer;</div><div class="line"></div><div class="line">                    logSyncerThread.hlogFlush(tempWriter, pending);</div><div class="line"></div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>查看了下代码，是在logSyncerThread.hlogFlush往HDFS写文件发生IO Exception时会触发死锁。<a href="http://www.rigongyizu.com/tag/hbase/" target="_blank" rel="external">hbase</a> 0.94.X版本的一个bug，在社区已经修复了：<a href="https://issues.apache.org/jira/browse/HBASE-7728" target="_blank" rel="external">https://issues.apache.org/jira/browse/HBASE-7728</a>。</p>
<h2 id="6、修复"><a href="#6、修复" class="headerlink" title="6、修复"></a>6、修复</h2><p>​    临时的修复方案是sync所有的memstore后、重启regionserver</p>
<p>​    长久的修复方案就是老老实实打patch修复</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/24/HBase从0-94升级到0-98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/11/24/HBase从0-94升级到0-98/" itemprop="url">HBase从0.94升级到0.98</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-11-23T11:56:29-08:00">
                2014-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、HBase0-98和0-96两个版本的一些变化"><a href="#一、HBase0-98和0-96两个版本的一些变化" class="headerlink" title="一、HBase0.98和0.96两个版本的一些变化"></a>一、HBase0.98和0.96两个版本的一些变化</h1><p>HBase0.98:</p>
<p>1、支持了reverse的scan模式(HBASE-4811)。</p>
<p>​      用户可以正向的或者反向的扫描表，这个和正向扫描仅仅有一点点的性能差别，使用的方法如下：</p>
<p>​      Scan scan = new Scan();</p>
<p>​      scan.setReversed(true);</p>
<p>2、Compaction升级成了Stripe Compaction(HBASE-7667)</p>
<p>​    按照以往的经验,首先，过多Region会增大RS维护的开销，降低RS的读写性能。随着数据量的增大，在一定程度上增加Region个数，会提高系统的吞吐率。然而，RS上服务的Region个数增多，增加了RS下内存维护的开销，尤其每个Store下都配置有一个MemStore，从而会造成频率更高的Flush操作，影响系统的读写性能。因此，如果能够提出更轻量级的mini-Region，不仅能够降低服务多个Region的开销，而且能够提升读写数据的效率;其次，Region Compaction容易”放大”。例如，Region区间[1FFF，2FFF）,在该区间内仅有[1FFF，21FF)区间有大量的写操作(put、delete)，但是,在触及MajorCompaction条件时，却需要对所有的文件执行Major Compaction，从而引起大量的IO。最后，Region Split操作代价较大。</p>
<p>​     为了减少region的数量，同时能降低compaction带来的影响，在新版本中加入了Stripe Compaction。其核心思想如下：</p>
<p>​     1）对于Region下的rowkey区间进行二次切分，例如[1FFF,2FFF)，切分成[1FFF,24FF),[24FF,2FFF)两个区间，每个区间成为Stripe。</p>
<p>​     2）Region下的数据文件分为Level-0和Level-1两层。其中Level-0主要用来存储临时的数据文件(例如使用bulkload或者执行mem flush操作之后的数据)， Level-1层的数据是按照Stripe的分区来区分。</p>
<p>​     3）支持两种方式的配置：Mini-regions的个数设置、或者以Size-based为大小触发因子的自动切分机制。</p>
<p>​     4）容错机制。如果在Stripes之间存在空洞。那么可以根据在Store当中的设置，将所有的处于Level-1层的文件回归到Level-0重新进行compaction。</p>
<p>​     5）Get操作时，一个Row所涉及到文件有：MemStore、Level-0下所有文件、以及Level-1下对应Stripe区下的文件。根据Stack的意见，最终Level-0下的文件只是一个暂时的状态，大部分文件都位于Level-1 Stripe下，因此，这样随机读时，需要涉及到的文件更聚集。</p>
<p>​     6）Scan操作时，需要定位startrow即可。在扫描过程中，会按照Stripe的row区间的排序，依次进行。</p>
<p>​     7）Compaction，是Level-0上升到Level-1的过程，同时，在Level-1层次的数据，也会进行相关的合并。</p>
<p>​     8）在Split操作时，定位Rowkey区间的中心点，可以根据Stripe记录的位置，进一步查找，因此，使用预置的Stripe会有利于Split操作的进行，可以实现多数HFile文件直接拷贝到子Region目录，从而加快了Split操作的效率。</p>
<p>下面对于Cassandra以及LevelDB中使用的多层次Compaction算法做一个介绍。</p>
<p>​    1)分层式压缩方式将数据分成条个层，最底层的叫L0，其上分别是L1，L2….，每一层的数据大小是其上的那一层数据最大大小的10倍，其中最底层L0的大小为5M (可以配置)</p>
<p>​    2) 当level层次大于0时，同一层的各个文件之间的Rowkey区间不会重叠。所以在level n与level n+1的数据块进行合并时，可以明确的知道某个key值处在哪个数据块中，可以一个数据块一个数据块的合并，合并后生成新块就丢掉老块。不用一直到所有合并完成后才能删除老的块。</p>
<p>​     3）整体执行流程是从L0-&gt;L1-&gt;L2，依次合并的过程，如下图所示。</p>
<p>​     <a href="http://www.binospace.com/wp-content/uploads/2013/06/compaction1.png" target="_blank" rel="external">http://www.binospace.com/wp-content/uploads/2013/06/compaction1.png</a></p>
<p>由上图，我们可以得知，越是level较低的块，它的数据就越新，在满足向下归约合并的过程中，就会按照文件的Rowkey的区间，进行合并，去除多余的版本，或者执行相关删除操作。因此，在读请求最极端的情况下，从Level0开始读数据，一直读到最下层Level n。这种Compaction的优势在于：</p>
<p>1）大部分的读操作如果有LRU特性，都会落入较低的Level上。因此，数据越”热”，Level就越低。从而有利于未来HFile多种存储介质的定位问题。</p>
<p>2）在合并的过程中，仅需在由上到下的部分文件参与，而不是要对所有文件执行Compaction操作。这样会加快Compaction执行的效率。</p>
<p>劣势在于，如果层次太多，在递归合并的过程中，容易造成某个区间的Compaction风暴，影响该区间数据操作的吞吐。</p>
<p>因此，HBase-Stripe Compaction的方案中，只有两层，Level 0和Level1，这种方法在保留分层压缩的优势的同时，降低了总文件个数，有利于RS执行Split、Merge等操作。</p>
<p>3、支持对快照进行MR(HBASE-8369)</p>
<p>​    现在快照作为hbase的元数据的一个分支文件，一个快照文件包含了表描述符、包含的region列表、reion的存储文件、region的相关WAL。利用HBase的快照进行MR，就是实现对RS的直接操作，类似与HDFS的直读(<a href="http://www.importnew.com/6151.html)。通过TableSnapshotInputFormat和TableSnapshotScanner" target="_blank" rel="external">http://www.importnew.com/6151.html)。通过TableSnapshotInputFormat和TableSnapshotScanner</a> 把表快照发送到客户端，然后客户端的操作就可以绕过HBase的Server层，直接通过java程序或者MR来流式的获取scan的结果(大概有5倍的性能提升)。可以参考<a href="http://www.slideshare.net/enissoz/mapreduce-over-snapshots" target="_blank" rel="external">http://www.slideshare.net/enissoz/mapreduce-over-snapshots</a></p>
<p>4、基于Cell的ACL以及可视化(HBASE-6222))</p>
<p>   类似与apache accumulo，其ACL的功能主要是为每个独立的cell提供强制访问控制。可视化的功能主要是利用了HBase本身的协处理器，然后结合ACL实现的。然后授予用户可以查看这个标签的权限，这些ACL的数据存储在HBase的一个新的系统表中。</p>
<p>对于如果使用这个特性，可以参考：<a href="https://blogs.apache.org/hbase/entry/hbase_cell_security和" target="_blank" rel="external">https://blogs.apache.org/hbase/entry/hbase_cell_security和</a></p>
<p>对于特性的详细描述，请参考：<a href="https://hbase.apache.org/book/security.html" target="_blank" rel="external">https://hbase.apache.org/book/security.html</a></p>
<p>5、透明的服务器端的加密(HBASE-7544)</p>
<p>​      这个特性主要提供了对wal和hfile的加密，主要是为REST接口提供的。</p>
<p>6、其它的一些小的功能点：</p>
<p>​       wal线程模式(HBASE-8755)、基于REST接口的流扫描(HBASE-9343)、解决了客户读访问Server的时候RPC数异常增长的BUG(HBASE-3787)</p>
<p>HBase0.96</p>
<p>   HBase0.96中改变大部分是向后兼容的，但是一部分是不向后兼容的，接下来分别指出：</p>
<p>   不兼容的改变：</p>
<p>​       删除了-ROOT-表(HBASE-3171) </p>
<p>​       </p>
<p>不再支持hadoop0.20(HBASE-6706) </p>
<p>更改了zk上的节点的名称(HBASE-4451 )</p>
<p>不支持HFileV1(HBASE-7660)</p>
<p>删除了Avro(HBASE-6553)</p>
<p>删除了客户端的行锁(HBASE-7315 HBASE-7263)</p>
<p>其它的改变：</p>
<p>   1、Bucket Cache-HBase的二级读cache( HBASE-7404)</p>
<p>​     HBase上Regionserver的内存分为两个部分，一部分作为Memstore，主要用来写；另外一部分作为BlockCache，主要用于读。Block的cache命中率对HBase的读性能影响十分大。在之前的版本中默认的是LruBlockCache，直接使用JVM的HashMap来管理BlockCache，会有Heap碎片和Full GC的问题。</p>
<p>在新版本中引入了Bucket Cache的概念。Bucket Cache可以放在内存中，也可以放在像SSD这样的适合高速随机读的外存储设备上，这样使得缓存的空间可以非常大，可以显著提高HBase读性能。Bucket Cache的本质是让HBase自己来管理内存资源而不是让Java的GC来管理，这个特点也是HBase自从诞生以来一直在激烈讨论的问题。</p>
<p>​     可以参考<a href="http://zjushch.iteye.com/blog/1751387" target="_blank" rel="external">http://zjushch.iteye.com/blog/1751387</a></p>
<p>   2、MSLAB(HBASE-8163)</p>
<p>​     MSLAB提升支持 MemStore-Local Allocation Buffers，通过预先分配内存块的方式解决了因为内存碎片造成的Full GC问题，但是对于频繁更新操作的时候，MemStore被flush到文件系统时没有reference的chunk还是会触发很多的Young GC。所以提出了MemStoreChunkPool的概念，也就是由HBase来管理一个ChunkPool用来存放chunk，不再依赖JVM的GC。这个ticket的本质也是由HBase进程来管理内存分配和重分配，不再依赖于Java GC。</p>
<p>​      可以参考：<a href="http://www.taobaotest.com/blogs/2310" target="_blank" rel="external">http://www.taobaotest.com/blogs/2310</a></p>
<p>   3、支持在线的region merge(HBASE-8219):</p>
<p>​      在线的region merge是移动快照，而离线的是真正的合并数据</p>
<p>​     4、变化比较大的 Compaction</p>
<p>​      HBase的Compaction是长期以来广受诟病的一个feature，很多人吐槽HBase也是因为这个特征。不过我们不能因为HBase有这样一个缺点就把它一棒子打死，更多的还是希望能够驯服它，能够使得它适应自己的应用场景。根据业务负载类型调整compaction的类型和参数，一般在业务高峰时候禁掉Major Compaction。在0.96中HBase社区为了提供更多的compaction的策略适用于不同的应用场景，采用了插件式的架构。同时改进了HBase在RegionServer端的存储管理，原来是直Region-&gt;Store-&gt;StoreFile，现在为了支持更加灵活多样的管理StoreFile和compact的策略，RS端采用了StoreEngine的结构。一个StoreEngine涉及到StoreFlusher, CompactionPolicy, Compactor, StoreFileManager。不指定的话默认是DefaultStoreEngine，四个组件分别是DefaultStoreFlusher, ExploringCompactionPolicy,DefaultCompactor, DefaultStoreFileManager。默认的Compaction算法从RatioBasedCompactionPolicy改为了ExploringCompactionPolicy。为什么要这么改，首先从compaction的优化目标来看：compaction is about trading some disk IO now for fewer seeks later，也就是compaction的优化目标是执行Compaction操作能合并越多的文件越好，如果合并同样多的文件产生的IO越小越好，这样select出来的列表才是最优的。</p>
<p>主要不同在于：RatioBasedCompactionPolicy是简单的从头到尾遍历StoreFile列表，遇到一个符合Ratio条件的序列就选定执行compaction。对于典型的不断flush memstore形成 StoreFile的场景是合适的，但是对于bulk-loaded是不合适的，会陷入局部最优。而ExploringCompactionPolicy则是从头到尾遍历的同时记录下当前最优，然后从中选择一个全局最优列表。</p>
<p>​          关于这两个算法的逻辑可以在代码中参考对应的applyCompactionPolicy()函数。其他Compaction Policy的研究和开发也非常活跃，例如Tier-based compaction (HBASE-6371,来自Facebook) 和stripe compaction(HBASE-7667)</p>
<p>​        此外compaction还有很多修改，参考HBASE-7678 、HBASE-766 、HBASE-7110、HBASE-7603、</p>
<p>HBASE-7842</p>
<p>​          吐槽：HBase compaction为什么会问题这么多，我感觉缺少了一个整体的IO负载的反馈和调度机制。因为compaction是从HDFS读数据，然后再写到HDFS中，和其他HDFS上的负载一样在抢占IO资源。如果能有个IO资源管理和调度的机制，在HDFS负载轻的时候执行compaction，在负载重的时候不要执行。而且这个问题在Hadoop/HDFS里同样存在，Hadoop的资源管理目前只针对CPU/Memory的资源管理，没有对IO的资源管理，会导致有些Job受自己程序bug的影响可能会写大量的数据到HDFS，会严重影响其他正常Job的读写性能。</p>
<p>​     5、Mean Time To Recovery/MTTR优化</p>
<p>​       目前HBase对外提供服务，Region Server是单点。如果某台RS挂掉，那么直到该RS上的所有Region被重新分配到其他RS上之前，这些Region是的数据是无法访问的。</p>
<p>​        对这个过程的改进主要包括：</p>
<p>HBASE-5844 和 HBASE-5926：删除zookeeper上Region Server/Master对应的znode，这样就省的等到znode 30s超时才发现对应的RS/Master挂了。</p>
<p>HBASE-7006： Distributed Log Replay，就是直接从HDFS上读取宕机的WAL日志，直接向新分配的RS进行Log Replay，而不是创建临时文件recovered.edits然后再进行Log Replay</p>
<p>HBASE-7213/8631： HBase的META表中所有的Region所在的Region Server将会有两个WAL，一个是普通的，一个专门给META表对应的Region用。这样在进行recovery的时候可以先恢复META表。  </p>
<p>​    6、PrefixTreeCompression(HBASE-4676 )</p>
<p>​     由于HBase的KeyValue存储是按照Row/Family/Qualifier/TimeStamp/Value的形式存储的，Row/Family/Qualifier这些相当于前缀，如果每一行都按照原始数据进行存储会导致占据存储空间比较大。HBase 0.94版本就已经引入了DataBlock Encode的概念(HBASE-4218)，将重复的Row/Family/Qualifier按照顺序进行压缩存储，提高内存利用率，支持四种压缩方式FAST_DIFF\PREFIX\PREFIX_TRIE\DIFF。但是这个feature也仅仅是通过delta encoding/compression降低了内存占用率，对数据查询效率没有提升，甚至会带来压缩/解压缩对CPU资源占用的情况。</p>
<p>​      PrefixTreeCompression是把重复的Row/Family/Qualifier按照Prefix Tree的形式进行压缩存储的，可以在解析时生成前缀树，并且树节点的儿子是排序的，所以从DataBlock中查询数据的效率可以超过二分查找。</p>
<p>7、使用了Protocol Buffer(HBASE-5305):</p>
<p>​    为了更好的跨版本的兼容性，引进了Protocol Buffer作为序列化/反序列化引擎使用到RPC中(此前Hadoop的RPC也全部用PB重写了)。因为随着HBase Server的不断升级，有些Client的版本可能还比较旧，所以需要RPC在新旧版本之间兼容。</p>
<p>​       8、 HBase Table Snapshot(HBASE-6055 HBASE-7290):</p>
<p>创建snaphost对HBase集群没有性能影响，只是生成了snaphost对应的metadata而不会去拷贝数据。用户可以通过创建snaphost实现backup和disaster recovery，例如用户在创建一个snaphost之后可能会误操作导致一些表出现了问题，这样我们可以选择回滚到创建snaphost的那个阶段而不会导致数据全都不可用。也可以定期创建snapshot然后拷贝到其他集群用于定时的offline processing</p>
<p>​    9、HBASE-8015：在0.96中，ROOT表已经改名为hbase:namespace，META则是hbase:meta。而且hbase:namespace是存在zookeeper上的。这个namespace类似于RDBMS里的database的概念，可以更好的做权限管理和安全控制。HBase中table的META信息也是作为一种Region存放在Region Server上的，那么META表的Region和其他普通Region就会产生明显的资源竞争。为了改善META Region的性能，360的HBase中提出了专属MetaServer，在这个Region Server上只存放META Region</p>
<p>10、HBASE-5229：同一个Region内的跨行事务。一次操作中涉及到同一个Region中的所有写操作在获取到的相关Row的所有行锁（按照RowKey的顺序依次取行锁，防止死锁）之后事务执行。</p>
<p>11、HBASE-4811：Reverse Scan。过去被问到说如何反向查找HBase中的数据，常常被答道再建一张反向存储的表，而且LevelDB和Cassandra都支持反向扫描。HBase反向扫描比正向扫描性能下降30%，这个和LevelDB是差不多的。</p>
<p>12、在不用安装cygwin的情况下支持在windows下安装</p>
<p>13、Hoya — HBase on YARN。可以在一个YARN集群上部署多个不同版本、不同配置的HBase instance，可以参考 <a href="https://github.com/hortonworks/hoya" target="_blank" rel="external">https://github.com/hortonworks/hoya</a></p>
<p>14、集成测试环境，从Netflix刚开源的Chaos Monkey中集成了一个测试环境，支持大规模的测试。</p>
<p>15、灵活的数据类型支持，详细请看<a href="https://blogs.apache.org/hbase/entry/data_types_schema" target="_blank" rel="external">https://blogs.apache.org/hbase/entry/data_types_schema</a></p>
<p>16、模块化，HBase已经拆分成了server、client等很多独立的模块。</p>
<p>17、提升了HBase的监控功能hbase tracing，HBASE-9121                     </p>
<p>​            <a href="https://blogs.apache.org/hbase/entry/migration_to_the_new_metrics" target="_blank" rel="external">https://blogs.apache.org/hbase/entry/migration_to_the_new_metrics</a></p>
<p>18、新的balancer的算法，类似与Simulated annealing 或者 Greedy Hillclimbing，不仅仅是更具数量来进行负载均衡，还增加了对读写的判断。 </p>
<p>​       19、增加了一些新的API的支持(HBase-8693、HBase8089、HBase8201)</p>
<p>20、通过调用mlockall增加了服务的稳定性(HBase4391)</p>
<h1 id="二、常用的一些API相关地址："><a href="#二、常用的一些API相关地址：" class="headerlink" title="二、常用的一些API相关地址："></a>二、常用的一些API相关地址：</h1><p>   1、详细HBase的基本API查询</p>
<p>   2、HBase的社区的所有BUG已经新特性的集合</p>
<p>   3、HBase Book</p>
<h1 id="三、HBASE发展方向"><a href="#三、HBASE发展方向" class="headerlink" title="三、HBASE发展方向"></a>三、HBASE发展方向</h1><p>   总的来说，HBase正在往更加好的方向发展，但是不同的需求造就了HBase本身也有各种不同的需求：</p>
<p>1、 Cloudera/Hortonworks/Yahoo/Facebook的人从系统和性能等多方面关注</p>
<p>2、Salesfore/huawei的人貌似更关注企业级特性，毕竟他们面对的客户都是电信、金融、证券等高帅富行业</p>
<p>3、来自国内的阿里巴巴/小米/360等公司更加关注系统性能、稳定性和运维相关的话题。国内互联网行业用HBase更加关注的是如何解决业务问题。</p>
<p>4、越来越多的公司把它们的HBase集群构建在云上，例如Pinterest所有的HBase集群都是在AWS上，国外的start up环境太好了，有了AWS自己根本不用花费太多的资源在基础设施上。</p>
<p>5、传统的HBase应用是online storage，实时数据读取服务。例如支付宝用HBase存放用户的历史交易信息服务用户查询，中国联通也使用HBase存储用户的上网历史记录信息用于用户的实时查询需求。现在HBase也向实时数据挖掘的应用场景中发展，例如wibidata公司开源的kiji (<a href="http://www.kiji.org/)能够在HBase上轻松构建实时推荐引擎、实时用户分层和实时欺诈监控。" target="_blank" rel="external">http://www.kiji.org/)能够在HBase上轻松构建实时推荐引擎、实时用户分层和实时欺诈监控。</a></p>
<p>参考资料：</p>
<p><a href="https://blogs.apache.org/hbase/entry/hbase_0_96_0_released" target="_blank" rel="external">https://blogs.apache.org/hbase/entry/hbase_0_96_0_released</a></p>
<p><a href="http://zh.hortonworks.com/blog/announcing-apache-hbase-0-96/" target="_blank" rel="external">http://zh.hortonworks.com/blog/announcing-apache-hbase-0-96/</a></p>
<p><a href="http://www.binospace.com/index.php/hbase-new-features-stripe-compaction/" target="_blank" rel="external">http://www.binospace.com/index.php/hbase-new-features-stripe-compaction/</a></p>
<p><a href="http://zh.hortonworks.com/blog/hbase-0-98-0-released/" target="_blank" rel="external">http://zh.hortonworks.com/blog/hbase-0-98-0-released/</a></p>
<p><a href="http://yanbohappy.sinaapp.com/?p=434" target="_blank" rel="external">http://yanbohappy.sinaapp.com/?p=434</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/10/30/HBase客户端开发建议/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/30/HBase客户端开发建议/" itemprop="url">HBase客户端开发建议</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-29T11:07:52-08:00">
                2014-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>​     1、HTable不是线程安全的。建议使用同一个HBaseConfiguration实例来创建HTable实例。这样可以共享ZooKeeper和socket实例。对于需要多线程大量写入HBase的，提供了HTablePool来支持多线程写入hbase，多线程同时从HTablePool中取出HTable并写入是安全的。</p>
<p>​       2、如果为了加快写的速度，设置了客户端的写缓存池，并且关闭了HTable对象的AutoFlush，那么在完成所有的操作后，最好调用HTable对象的close和flushCommits的操作，这样才能保证写到缓存池中的数据全部传送到服务器端。</p>
<p>​       3、当flush的时候，现有的memstore会生成快照，然后清空。在执行快照的时候，Hbase会继续接收修改操作，保存在memstore外面，直到快照完成，所以在flush的时候，应该避免大量的写入，可能会导致数据不同步。</p>
<p>未完待续…</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/10/21/在Django项目中REST接口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/21/在Django项目中REST接口/" itemprop="url">在Django项目中REST接口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-20T19:00:41-08:00">
                2014-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本的环境搭建："><a href="#基本的环境搭建：" class="headerlink" title="基本的环境搭建："></a>基本的环境搭建：</h1><p>   经过调研，要使用<a href="http://www.django-rest-framework.org/#django-rest-framework" target="_blank" rel="external">http://www.django-rest-framework.org/#django-rest-framework</a></p>
<h2 id="1、安装相关的软件："><a href="#1、安装相关的软件：" class="headerlink" title="1、安装相关的软件："></a>1、安装相关的软件：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pip install djangorestframework</div><div class="line"></div><div class="line">pip install markdown</div><div class="line"></div><div class="line">pip install django-filter</div></pre></td></tr></table></figure>
<h2 id="2、安装新的app："><a href="#2、安装新的app：" class="headerlink" title="2、安装新的app："></a>2、安装新的app：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py startapp rest</div></pre></td></tr></table></figure>
<h2 id="3、加入新的app："><a href="#3、加入新的app：" class="headerlink" title="3、加入新的app："></a>3、加入新的app：</h2><p>   编辑setting.py,在INSTALLED_APPS中加入以下两个app</p>
<p>​    ‘rest’, //自定义的新增加的APP</p>
<p>​    ‘rest_framework’, //为djangon引入的rest接口</p>
<p>   同时增加：</p>
<p>   REST_FRAMEWORK = { </p>
<p>​    # Use Django’s standard <code>django.contrib.auth</code> permissions, </p>
<p>​    # or allow read-only access for unauthenticated users. </p>
<p>​    ‘DEFAULT_PERMISSION_CLASSES’: [ </p>
<p>​        ‘rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly’ </p>
<p>​     ] </p>
<p>   } </p>
<p>   编辑urls.py，为新模块增加定义：</p>
<p>   url(r’^api-auth/‘, include(‘rest.urls’)),</p>
<h2 id="4、为新的模块增加urls-py的定义，如下："><a href="#4、为新的模块增加urls-py的定义，如下：" class="headerlink" title="4、为新的模块增加urls.py的定义，如下："></a>4、为新的模块增加urls.py的定义，如下：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include,patterns </div><div class="line"></div><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers, serializers, viewsets </div><div class="line"></div><div class="line">\<span class="comment"># Serializers define the API representation. </span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span><span class="params">(serializers.HyperlinkedModelSerializer)</span>:</span> </div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </div><div class="line"></div><div class="line">        model = User </div><div class="line"></div><div class="line">        fields = (<span class="string">'url'</span>, <span class="string">'username'</span>, http://<span class="number">192.168</span><span class="number">.24</span><span class="number">.131</span>:<span class="number">9000</span>/api-auth/test1/<span class="number">2</span>/<span class="string">'email'</span>, <span class="string">'is_staff'</span>) </div><div class="line"></div><div class="line">\<span class="comment"># ViewSets define the view behavior. </span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span> </div><div class="line"></div><div class="line">    queryset = User.objects.all() </div><div class="line"></div><div class="line">    serializer_class = UserSerializer </div><div class="line"></div><div class="line">\<span class="comment"># Routers provide an easy way of automatically determining the URL conf. </span></div><div class="line"></div><div class="line">router = routers.DefaultRouter() </div><div class="line"></div><div class="line">router.register(<span class="string">r'users'</span>, UserViewSet) </div><div class="line"></div><div class="line">\<span class="comment"># Wire up our API using automatic URL routing. </span></div><div class="line"></div><div class="line">\<span class="comment"># Additionally, we include login URLs for the browseable API. </span></div><div class="line"></div><div class="line">urlpatterns = patterns(<span class="string">'api.views'</span>, </div><div class="line"></div><div class="line">    url(<span class="string">r'^test1/'</span>, include(router.urls)), </div><div class="line"></div><div class="line">    url(<span class="string">r'^test2/'</span>, include(<span class="string">'rest_framework.urls'</span>, namespace=<span class="string">'rest_framework'</span>)), </div><div class="line"></div><div class="line">)</div></pre></td></tr></table></figure>
<p>​    完成上面的步骤后，重启django的项目，访问django-address/auth-api/test1就可以看到新增加的REST接口的hello world，接下来进入开发。</p>
<h1 id="开发一个简单的例子"><a href="#开发一个简单的例子" class="headerlink" title="开发一个简单的例子"></a>开发一个简单的例子</h1><p>​    1、允许我普及一下，如果对于一个非REST的Django项目来说，我们应该怎么开发。</p>
<p>​    首先创建模板类，修改models.py如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snippet</span><span class="params">(models.Model)</span>:</span> </div><div class="line"></div><div class="line">    created = models.DateTimeField(auto_now_add=<span class="keyword">True</span>) </div><div class="line"></div><div class="line">    title = models.CharField(max_length=<span class="number">100</span>, blank=<span class="keyword">True</span>, default=<span class="string">''</span>) </div><div class="line"></div><div class="line">    code = models.TextField() </div><div class="line"></div><div class="line">    linenos = models.BooleanField(default=<span class="keyword">False</span>) </div><div class="line"></div><div class="line">    language = models.CharField(default=<span class="string">'python'</span>, </div><div class="line"></div><div class="line">                                max_length=<span class="number">100</span>) </div><div class="line"></div><div class="line">    style = models.CharField(default=<span class="string">'friendly'</span>, </div><div class="line"></div><div class="line">                             max_length=<span class="number">100</span>) </div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </div><div class="line"></div><div class="line">        ordering = (<span class="string">'created'</span>,)</div></pre></td></tr></table></figure>
<p>然后要记得执行python manage.py syncdb，这样才能让模型生效到数据库中。</p>
<p>​    然后创建一个序列化的类serializers.py，这个类的主要作用是把从数据库中取出的字段序列化成一中好读的格式，比如json，当然也需要有反序列化的功能，定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> widgets </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest.models <span class="keyword">import</span> Snippet </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.Serializer)</span>:</span> </div><div class="line"></div><div class="line">   //这部分定义了序列化和反序列化过程中的一些基本字段</div><div class="line"></div><div class="line">    pk = serializers.Field()  <span class="comment"># Note: `Field` is an untyped read-only field. </span></div><div class="line"></div><div class="line">    title = serializers.CharField(required=<span class="keyword">False</span>, </div><div class="line"></div><div class="line">                                  max_length=<span class="number">100</span>) </div><div class="line"></div><div class="line">    code = serializers.CharField(widget=widgets.Textarea, </div><div class="line"></div><div class="line">                                 max_length=<span class="number">100000</span>) </div><div class="line"></div><div class="line">    linenos = serializers.BooleanField(required=<span class="keyword">False</span>) </div><div class="line"></div><div class="line">    language = serializers.ChoiceField(default=<span class="string">'python'</span>) </div><div class="line"></div><div class="line">    style = serializers.ChoiceField(default=<span class="string">'friendly'</span>) </div><div class="line"></div><div class="line">//这个方法定义了这些字段和models中的字段的对应关系</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">restore_object</span><span class="params">(self, attrs, instance=None)</span>:</span> </div><div class="line"></div><div class="line">        <span class="string">""" </span></div><div class="line"></div><div class="line">        Create or update a new snippet instance, given a dictionary </div><div class="line"></div><div class="line">        of deserialized field values. </div><div class="line"></div><div class="line">        Note that if we don't define this method, then deserializing </div><div class="line"></div><div class="line">        data will simply return a dictionary of items. </div><div class="line"></div><div class="line">        """ </div><div class="line"></div><div class="line">        <span class="keyword">if</span> instance: </div><div class="line"></div><div class="line">            <span class="comment"># Update existing instance </span></div><div class="line"></div><div class="line">            instance.title = attrs.get(<span class="string">'title'</span>, instance.title) </div><div class="line"></div><div class="line">            instance.code = attrs.get(<span class="string">'code'</span>, instance.code) </div><div class="line"></div><div class="line">            instance.linenos = attrs.get(<span class="string">'linenos'</span>, instance.linenos) </div><div class="line"></div><div class="line">            instance.language = attrs.get(<span class="string">'language'</span>, instance.language) </div><div class="line"></div><div class="line">            instance.style = attrs.get(<span class="string">'style'</span>, instance.style) </div><div class="line"></div><div class="line">            <span class="keyword">return</span> instance </div><div class="line"></div><div class="line">       <span class="comment"># Create new instance </span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> Snippet(**attrs)</div></pre></td></tr></table></figure>
<p>接下来我们用python manage.py shell来操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; <span class="keyword">from</span> rest.models <span class="keyword">import</span> Snippet </div><div class="line"></div><div class="line">\&gt;&gt;&gt; <span class="keyword">from</span> rest.serializers <span class="keyword">import</span> SnippetSerializer </div><div class="line"></div><div class="line">\&gt;&gt;&gt; <span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer </div><div class="line"></div><div class="line">\&gt;&gt;&gt; <span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser </div><div class="line"></div><div class="line">\&gt;&gt;&gt; snippet = Snippet(code=<span class="string">'foo = "bar"\n'</span>) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; snippet.save() </div><div class="line"></div><div class="line">\&gt;&gt;&gt; snippet = Snippet(code=<span class="string">'print "hello, world"\n'</span>) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; snippet.save() </div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer = SnippetSerializer(snippet) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer.data</div></pre></td></tr></table></figure>
<p>{‘pk’: 2L, ‘title’: u’’, ‘code’: u’print “hello, world”\n’, ‘linenos’: False, ‘language’: u’python’, ‘style’: u’friendly’} </p>
<p>//我们在数据库中插入了2条数据，然后通过序列化的类，显示成了json的格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; <span class="keyword">from</span> rest_framework.compat <span class="keyword">import</span> BytesIO </div><div class="line"></div><div class="line">\&gt;&gt;&gt; content = JSONRenderer().render(serializer.data) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; content </div><div class="line"></div><div class="line"><span class="string">'&#123;"pk": 2, "title": "", "code": "print \\"hello, world\\"\\n", "linenos": false, "language": "python", "style": "friendly"&#125;'</span> </div><div class="line"></div><div class="line">\&gt;&gt;&gt; stream = BytesIO(content) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; data = JSONParser().parse(stream) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; data</div></pre></td></tr></table></figure>
<p>{u’style’: u’friendly’, u’code’: u’print “hello, world”\n’, u’language’: u’python’, u’title’: u’’, u’linenos’: False, u’pk’: 2} </p>
<p>//这里我们把models中的数据和json数据进行了序列化和反序列化展示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; serializer = SnippetSerializer(data=data) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer.is_valid() </div><div class="line"></div><div class="line"><span class="keyword">False</span> </div><div class="line"></div><div class="line">\&gt;&gt;&gt; <span class="comment"># True </span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer.object </div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer = SnippetSerializer(Snippet.objects.all(), many=<span class="keyword">True</span>) </div><div class="line"></div><div class="line">\&gt;&gt;&gt; serializer.data</div></pre></td></tr></table></figure>
<p>[{‘pk’: 1L, ‘title’: u’’, ‘code’: u’foo = “bar”\n’, ‘linenos’: False, ‘language’: u’python’, ‘style’: u’friendly’}, {‘pk’: 2L, ‘title’: u’’, ‘code’: u’print “hello, world”\n’, ‘linenos’: False, ‘language’: u’python’, ‘style’: u’friendly’}] </p>
<p>​     2、使用REST的类实现序列化和反序列化：</p>
<p>​    重新定义serializers.py，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> widgets </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest.models <span class="keyword">import</span> Snippet </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span> </div><div class="line"></div><div class="line">​    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </div><div class="line"></div><div class="line">​        model = Snippet </div><div class="line"></div><div class="line">​        fields = (<span class="string">'id'</span>,<span class="string">'title'</span>, <span class="string">'code'</span>, <span class="string">'linenos'</span>, <span class="string">'language'</span>, <span class="string">'style'</span>) </div><div class="line"></div><div class="line">   REST framwork提供了 ModelSerializer的类方便的进行models和输出结果之间的转换。</div><div class="line"></div><div class="line">   最后一步是完成views.py，来处理前台的REST请求，内容如下：</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse </div><div class="line"></div><div class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest.models <span class="keyword">import</span> Snippet </div><div class="line"></div><div class="line"><span class="keyword">from</span> rest.serializers <span class="keyword">import</span> SnippetSerializer </div><div class="line"></div><div class="line"><span class="keyword">import</span> logging </div><div class="line"></div><div class="line">logger = logging.getLogger(<span class="string">'ac_file'</span>) </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONResponse</span><span class="params">(HttpResponse)</span>:</span> </div><div class="line"></div><div class="line">    <span class="string">""" </span></div><div class="line"></div><div class="line">    An HttpResponse that renders its content into JSON. </div><div class="line"></div><div class="line">    """ </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data, **kwargs)</span>:</span> </div><div class="line"></div><div class="line">        content = JSONRenderer().render(data) </div><div class="line"></div><div class="line">        kwargs[<span class="string">'content_type'</span>] = <span class="string">'application/json'</span> </div><div class="line"></div><div class="line">        super(JSONResponse, self).__init__(content, **kwargs) </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span><span class="params">(request)</span>:</span> </div><div class="line"></div><div class="line">    logger.debug(request) </div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>: </div><div class="line"></div><div class="line">        snippets = Snippet.objects.all() </div><div class="line"></div><div class="line">        serializer = SnippetSerializer(snippets, many=<span class="keyword">True</span>) </div><div class="line"></div><div class="line">        <span class="keyword">return</span> JSONResponse(serializer.data) </div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'POST'</span>: </div><div class="line"></div><div class="line">       data = JSONParser().parse(request) </div><div class="line"></div><div class="line">        serializer = SnippetSerializer(data=data) </div><div class="line"></div><div class="line">        <span class="keyword">if</span> serializer.is_valid(): </div><div class="line"></div><div class="line">            serializer.save() </div><div class="line"></div><div class="line">            <span class="keyword">return</span> JSONResponse(serializer.data, status=<span class="number">201</span>) </div><div class="line"></div><div class="line">        <span class="keyword">return</span> JSONResponse(serializer.errors, status=<span class="number">400</span>) </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk)</span>:</span> </div><div class="line"></div><div class="line">    <span class="keyword">try</span>: </div><div class="line"></div><div class="line">        snippet = Snippet.objects.get(pk=pk) </div><div class="line"></div><div class="line">    <span class="keyword">except</span> Snippet.DoesNotExist: </div><div class="line"></div><div class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">404</span>) </div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>: </div><div class="line"></div><div class="line">        serializer = SnippetSerializer(snippet) </div><div class="line"></div><div class="line">        <span class="keyword">return</span> JSONResponse(serializer.data) </div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'PUT'</span>: </div><div class="line"></div><div class="line">        data = JSONParser().parse(request) </div><div class="line"></div><div class="line">        serializer = SnippetSerializer(snippet, data=data) </div><div class="line"></div><div class="line">        <span class="keyword">if</span> serializer.is_valid(): </div><div class="line"></div><div class="line">            serializer.save() </div><div class="line"></div><div class="line">            <span class="keyword">return</span> JSONResponse(serializer.data) </div><div class="line"></div><div class="line">        <span class="keyword">return</span> JSONResponse(serializer.errors, status=<span class="number">400</span>) </div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'DELETE'</span>: </div><div class="line"></div><div class="line">        snippet.delete() </div><div class="line"></div><div class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">204</span>) </div><div class="line"></div><div class="line">    </div><div class="line"></div><div class="line">    <span class="comment">#然后对urls.py稍做修改：</span></div><div class="line"></div><div class="line">        urlpatterns = patterns(<span class="string">'rest.views'</span>, </div><div class="line"></div><div class="line">    url(<span class="string">r'^test1/$'</span>, <span class="string">'snippet_list'</span>), </div><div class="line"></div><div class="line">    url(<span class="string">r'^test1/(?P[0-9]+)/$'</span>, <span class="string">'snippet_detail'</span>), </div><div class="line"></div><div class="line">)</div></pre></td></tr></table></figure>
<p>​    然后通过页面就可以访问序列化成json的数据了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/10/21/Python的生成器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/21/Python的生成器/" itemprop="url">Python生成器的基本理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-20T18:05:33-08:00">
                2014-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>python的生成器：yield</p>
<p>生成器和迭代器其实是一个相反的过程，可以简单的理解为，一个是创建，一个是消费。而生成器就是那个创建者：</p>
<p>   废话不多，直接例子：</p>
<p>​        </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; <span class="function"><span class="keyword">def</span> <span class="title">fu</span><span class="params">(nu)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> i <span class="keyword">in</span> range(nu):</div><div class="line"></div><div class="line"><span class="meta">... </span>            <span class="keyword">yield</span> i</div><div class="line"></div><div class="line">   在function fu中，轮寻了输入的数字，依次调用了生成器<span class="keyword">yield</span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; t=fu(<span class="number">3</span>)</div><div class="line"></div><div class="line">\&gt;&gt;&gt; t.next()</div><div class="line"></div><div class="line"><span class="number">0</span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; t.next()</div><div class="line"></div><div class="line"><span class="number">1</span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; t.next()</div><div class="line"></div><div class="line"><span class="number">2</span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; t.next()</div><div class="line"></div><div class="line">Traceback (most recent call last):</div><div class="line"></div><div class="line">  File <span class="string">""</span>, line <span class="number">1</span>, <span class="keyword">in</span></div><div class="line"></div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>  随后，在fu(3)的对象，可以调用next来轮寻的获取生成器中的结果，其实上面的例子类似于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; <span class="keyword">for</span> p <span class="keyword">in</span> fu(<span class="number">3</span>):</div><div class="line"></div><div class="line"><span class="meta">... </span>    <span class="keyword">print</span> p</div><div class="line"></div><div class="line"><span class="meta">... </span></div><div class="line"></div><div class="line"><span class="number">0</span></div><div class="line"></div><div class="line"><span class="number">1</span></div><div class="line"></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure>
<p>从上面的过程，我们可以最简单的理解生成器其实相当与一个队列，然后函数执行的过程中，把我们需要的输出都扔到队列中，然后就可以通过迭代来查看结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; type(fu)</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">\&gt;&gt;&gt; type(fu(<span class="number">3</span>))</div></pre></td></tr></table></figure>
<p>我们的猜测没错，fu函数已经不是一般的function了，它的对象不再是一个无类型的数据，而是一个迭代器了。对比如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">\&gt;&gt;&gt; type(fu(<span class="number">3</span>))</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">\&gt;&gt;&gt; <span class="function"><span class="keyword">def</span> <span class="title">fu</span><span class="params">(nu)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> i <span class="keyword">in</span> range(nu):</div><div class="line"></div><div class="line"><span class="meta">... </span>            <span class="keyword">print</span> i</div><div class="line"></div><div class="line"><span class="meta">... </span></div><div class="line"></div><div class="line">\&gt;&gt;&gt; type(fu(<span class="number">3</span>))</div><div class="line"></div><div class="line"><span class="number">0</span></div><div class="line"></div><div class="line"><span class="number">1</span></div><div class="line"></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure>
<p>从前面的例子中，可以看到，yield其实是对于逐渐生成结果的复杂递归算法的完美实现工具。这个特性在解决回溯的问题上有不错的表现。<br>  下面举一个实际中的例子，我们知道删除ZK节点的时候，API提供的delete只能删除不包含子目录的结点，这时候就需要递归删除，下面这个例子就是解决这个问题的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> zookeeper</div><div class="line"></div><div class="line">handle = zookeeper.init(<span class="string">"localhost:2181"</span>,<span class="number">10.0</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">recursiveGet</span><span class="params">(path)</span>:</span></div><div class="line"></div><div class="line">    children = zookeeper.get_children(handle,path)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> len(children) == <span class="number">0</span>:</div><div class="line"></div><div class="line">        <span class="keyword">for</span> childname <span class="keyword">in</span> children:</div><div class="line"></div><div class="line">            newPath = <span class="string">"%s%s%s"</span>%(path,<span class="string">"/"</span>,childname)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> allPath <span class="keyword">in</span> recursiveGet(newPath):</div><div class="line"></div><div class="line">                <span class="keyword">yield</span> allPath</div><div class="line"></div><div class="line">            <span class="keyword">yield</span> newPath</div><div class="line"></div><div class="line">    <span class="keyword">yield</span> path</div><div class="line"></div><div class="line"><span class="keyword">for</span> path <span class="keyword">in</span> recursiveGet(<span class="string">"/root"</span>):</div><div class="line"></div><div class="line">    <span class="keyword">print</span> path</div></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">/root/lap/abc</div><div class="line"></div><div class="line">/root/lap/abc</div><div class="line"></div><div class="line">/root/lap</div><div class="line"></div><div class="line">/root/lap</div><div class="line"></div><div class="line">/root/lap234/abcd</div><div class="line"></div><div class="line">/root/lap234/abcd</div><div class="line"></div><div class="line">/root/lap234</div><div class="line"></div><div class="line">/root/lap234</div><div class="line"></div><div class="line">/root/df/df2/abc/abc</div><div class="line"></div><div class="line">/root/df/df2/abc/abc</div><div class="line"></div><div class="line">/root/df/df2/abc</div><div class="line"></div><div class="line">/root/df/df2/abc</div><div class="line"></div><div class="line">/root/df/df2/abcd</div><div class="line"></div><div class="line">/root/df/df2/abcd</div><div class="line"></div><div class="line">/root/df/df2</div><div class="line"></div><div class="line">/root/df/df2</div><div class="line"></div><div class="line">/root/df</div><div class="line"></div><div class="line">/root/df</div><div class="line"></div><div class="line">/root/lap2/abc</div><div class="line"></div><div class="line">/root/lap2/abc</div><div class="line"></div><div class="line">/root/lap2</div><div class="line"></div><div class="line">/root/lap2</div><div class="line"></div><div class="line">/root/lap23</div><div class="line"></div><div class="line">/root/lap23</div><div class="line"></div><div class="line">/root</div></pre></td></tr></table></figure>
<p>上面可以看到，yield是一个递归神器，值得入手啊！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/21/HBase-Filter的介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/09/21/HBase-Filter的介绍/" itemprop="url">HBase Filter的介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-20T15:17:03-08:00">
                2014-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h1><p>因为HBase的所有数据聚合是在客户端完成的，所以Filter是HBase提供一个很重要的查询过滤神器，所以能够熟练的使用filter会让性能有质的飞跃。接下来分析一下HBase的Filter。</p>
<h1 id="几种常用的Filter"><a href="#几种常用的Filter" class="headerlink" title="几种常用的Filter"></a>几种常用的Filter</h1><h2 id="SingleColumnValueFilter和SingleColomnuValueExcludeFilter"><a href="#SingleColumnValueFilter和SingleColomnuValueExcludeFilter" class="headerlink" title="SingleColumnValueFilter和SingleColomnuValueExcludeFilter"></a>SingleColumnValueFilter和SingleColomnuValueExcludeFilter</h2><p>SingleColumnValueFilter 和 SingleColomnuValueExcludeFilter 这两个filter是比较简单的单个值的查询过滤器，构建了一个查询指定的行中指定的列值是否满足该条件的过滤器。这里可以进行的比较包括： LESS 、LESS_OR_EQUAL、EQUAL、NOT_EQUAL、GREATER_OR_EQUAL、GREATER、NO_OP 构建和使用的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SingleColumnValueFilter filter = <span class="keyword">new</span> SingleColumnValueFilter(Bytes.toBytes(<span class="string">"cf"</span>), Bytes.toBytes(<span class="string">"qualifier"</span>), CompareOp.EQUAL, Bytes.toBytes(<span class="string">"checkValue"</span>));</div><div class="line"></div><div class="line">get.setFilter(filter);</div></pre></td></tr></table></figure>
<p>上面的例子中构建了一个查询表中cf列中指定的qualifier中字段为checkValue的列。需要特别指出的是，过滤的条件，可以不是一个特定的值，也就是支持正则表达式，如下面的初始化filter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RegexStringComparator regexStringComparatorOrBuilder = <span class="keyword">new</span> RegexStringComparator(<span class="string">"abc."</span>);</div><div class="line"></div><div class="line">SingleColumnValueFilter filter = <span class="keyword">new</span> SingleColumnValueFilter(Bytes.toBytes(<span class="string">"cf"</span>), Bytes.toBytes(<span class="string">"qualifier"</span>), CompareOp.EQUAL, regexStringComparatorOrBuilder);</div></pre></td></tr></table></figure>
<p>不管是正则还是直接的值，这类型的过滤都是需要过滤在列簇里面具体的某一列的value。</p>
<h2 id="PageFilter"><a href="#PageFilter" class="headerlink" title="PageFilter"></a>PageFilter</h2><p>这是一个特殊的过滤器，它是过滤结果，指定了页面的行数，也就是返回对应行数的结果集，但是这里要说明，这里并不能保证返回结果的总行数小于与面的行数，这个仅仅能保证单独的一个RS返回的结果小于等于该行数，也就是如果这个表要查询的key值范围(对于scan来说)的分布在两个不同的RS上，那么结果返回的Result对象个数会超过过滤器的值。这个过滤器的作用是，防止单台机器上有很多的要查询结果，而导致这台机器的负载太高。接下来展示PageFilter的使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PageFilter pageFilter = <span class="keyword">new</span> PageFilter(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<h3 id="PrefixFilter、ColumnPrefixFilter、MultipleColumnPrefixFilter"><a href="#PrefixFilter、ColumnPrefixFilter、MultipleColumnPrefixFilter" class="headerlink" title="PrefixFilter、ColumnPrefixFilter、MultipleColumnPrefixFilter"></a>PrefixFilter、ColumnPrefixFilter、MultipleColumnPrefixFilter</h3><p>PrefixFilter、ColumnPrefixFilter、MultipleColumnPrefixFilter 这三个过滤器都是在对全表查询，然后找到行或者列中，满足一个或者多个过滤条件的过滤器。其中 PrefixFilter是查找所有rowkey满足规则结果集。ColumnPrefixFilter和MultipleColumnPrefixFilter分别是查询列中满足一个或者多个条件的列。综上所述，可以看到这两个过滤器是在查找表中满足某个规则的行或者列的时候用，但是这是一个全表的过滤，是比较耗时的。使用如下： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PrefixFilter pFilter = <span class="keyword">new</span> PrefixFilter(Bytes.toBytes(<span class="string">"a"</span>));</div><div class="line"></div><div class="line">ColumnPrefixFilter columnPrefixFilter= <span class="keyword">new</span> ColumnPrefixFilter(Bytes.toBytes(<span class="string">"a"</span>));</div><div class="line"></div><div class="line">MultipleColumnPrefixFilter multipleColumnPrefixFilter= <span class="keyword">new</span> MultipleColumnPrefixFilter(<span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;Bytes.toBytes(<span class="string">"a"</span>),Bytes.toBytes(<span class="string">"b"</span>)&#125;);</div></pre></td></tr></table></figure>
<h2 id="KeyOnlyFilter、FirstKeyOnlyFilter"><a href="#KeyOnlyFilter、FirstKeyOnlyFilter" class="headerlink" title="KeyOnlyFilter、FirstKeyOnlyFilter"></a>KeyOnlyFilter、FirstKeyOnlyFilter</h2><p>在查询的时候，可能会遇到只需要查询key的需求，这时候，可以使用KeyOnlyFilter。如果对于每个rowkey，只需要第一个符合条件的key，这时候就可以用FirstKeyOnlyFilter。申明方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">KeyOnlyFilter keyOnlyFilter = <span class="keyword">new</span> KeyOnlyFilter();</div><div class="line">FirstKeyOnlyFilter firstKeyOnlyFilter = <span class="keyword">new</span> FirstKeyOnlyFilter();</div></pre></td></tr></table></figure>
<h2 id="TimestampsFilter"><a href="#TimestampsFilter" class="headerlink" title="TimestampsFilter"></a>TimestampsFilter</h2><p>如果在某次查询中，需要查询的为指定的某个或者某几个时间戳的数据，可以使用TimestampsFilter。如果是使用scan查询，则可以直接调用scan对象的setTimeRange方法来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ListTimestamp = <span class="keyword">new</span> ArrayList();</div><div class="line"></div><div class="line">Timestamp.add(newLong(<span class="number">1</span>));</div><div class="line"></div><div class="line">Timestamp.add(newLong(<span class="number">2</span>));</div><div class="line"></div><div class="line">TimestampsFilter timestampsFilter = <span class="keyword">new</span> TimestampsFilter(Timestamp);</div></pre></td></tr></table></figure>
<h2 id="RandomRowFilter"><a href="#RandomRowFilter" class="headerlink" title="RandomRowFilter"></a>RandomRowFilter</h2><p>这是一个很特殊的行过滤器，初始化的时候只需要指定一个float的值。在随后的查询中，会随机查询该百分比的数据，如果小于0，则不会查询，如果大于1，就查询所有的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RandomRowFilter randomRowFilter = <span class="keyword">new</span> RandomRowFilter(<span class="number">0.5f</span>);</div></pre></td></tr></table></figure>
<p>//这样会从所有的数据中随机查询50%的数据，看是否有满足条件的查询</p>
<h2 id="DependentColumnFilter"><a href="#DependentColumnFilter" class="headerlink" title="DependentColumnFilter"></a>DependentColumnFilter</h2><p>DependentColumnFilter过滤器稍微复杂一点。它可以说是timeStamp Filter和ValueFilter的结合。因为DependentColumnFilter需要指定一个参考列，然后获取跟改参考列有相同时间戳的所有列，再在此基础上获取满足ValueFilter的列值。构造函数如下：用户可以根据自己喜好省略valueFilter或者通过设置dropDependentColumn为true省略timestamp Filter。不过需要注意的是：此过滤器不能跟Scan中的Batch操作结合使用。</p>
<h2 id="ValueFilter、QualifierFilter"><a href="#ValueFilter、QualifierFilter" class="headerlink" title="ValueFilter、QualifierFilter"></a>ValueFilter、QualifierFilter</h2><p>这两个都比较类似，分别是查询value和qualifilter是否等于，大于，小于某个值的过滤器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ValueFilter valueFilter = <span class="keyword">new</span> ValueFilter(CompareFilter.CompareOp.EQUAL,<span class="keyword">new</span> BinaryComparator(Bytes.toBytes(<span class="string">"value"</span>)));</div><div class="line"></div><div class="line">QualifierFilterqualifierFilter = <span class="keyword">new</span> QualifierFilter (CompareFilter.CompareOp.EQUAL,<span class="keyword">new</span> BinaryComparator(Bytes.toBytes(<span class="string">"qualifier"</span>)));</div></pre></td></tr></table></figure>
<h2 id="特殊的过滤器组合对象，FilterList"><a href="#特殊的过滤器组合对象，FilterList" class="headerlink" title="特殊的过滤器组合对象，FilterList"></a>特殊的过滤器组合对象，FilterList</h2><p>FilterList是一个过滤器的列表，前面所有的过滤器类型都可以放到这个列表中，然后可以选择过滤方式为全部满足或者单个满足(或者其它的)，这样使得过滤更加的强大。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FilterList filterList = newFilterList(FilterList.Operator.MUST_PASS_ALL);</div><div class="line">filterList.addFilter(timestampsFilter);</div><div class="line">...</div></pre></td></tr></table></figure>
<p>这里所有的过滤器，可以降低查询结果的数量，降低网络的传输消耗，但是本身并没有减少RPC的次数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/14/HBase-Thrift的部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/09/14/HBase-Thrift的部署/" itemprop="url">HBase Thrift的部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-13T19:57:53-08:00">
                2014-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="下载最新的thrift客户端："><a href="#下载最新的thrift客户端：" class="headerlink" title="下载最新的thrift客户端："></a>下载最新的thrift客户端：</h1><p>​    <a href="https://dist.apache.org/repos/dist/release/thrift/" target="_blank" rel="external">https://dist.apache.org/repos/dist/release/thrift/</a></p>
<h1 id="安装thift"><a href="#安装thift" class="headerlink" title="安装thift"></a>安装thift</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar -zxvf thrift-XXX.tar.gz</div><div class="line">cd thrift-XXX</div><div class="line">./configure –prefix=/usr/local/thrift-XXX</div><div class="line">make </div><div class="line">make install</div></pre></td></tr></table></figure>
<h1 id="生成Hbase相应的客户端文件："><a href="#生成Hbase相应的客户端文件：" class="headerlink" title="生成Hbase相应的客户端文件："></a>生成Hbase相应的客户端文件：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thrift –gen py $HBASE_HOME/src/main/resources/org/apache/hadoop/hbase/thrift/Hbase.thrift</div></pre></td></tr></table></figure>
<p> 会生成一个gen-py的文件夹，把该文件夹的内容拷贝到hbase的库目录下：</p>
<p> 默认是在/usr/lib/pythonXX/site-packages/</p>
<h2 id="测试thrift"><a href="#测试thrift" class="headerlink" title="测试thrift"></a>测试thrift</h2><p>写了一个简单的读表的python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</div><div class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</div><div class="line"><span class="keyword">from</span> hbase <span class="keyword">import</span> Hbase</div><div class="line"><span class="keyword">from</span> hbase.ttypes <span class="keyword">import</span> *</div><div class="line"></div><div class="line">clientIp = <span class="string">'localhost'</span></div><div class="line">clientPort = <span class="string">'9090'</span></div><div class="line">returnRet = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> len(sys.argv) &gt;= <span class="number">2</span>:</div><div class="line">    clientIp = sys.argv[<span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="keyword">if</span> len(sys.argv) &gt;= <span class="number">3</span>:</div><div class="line">    clientPort = sys.argv[<span class="number">2</span>]</div><div class="line">\<span class="comment">#open connection </span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    transport = TSocket.TSocket(clientIp, clientPort)</div><div class="line">    transport = TTransport.TBufferedTransport(transport)</div><div class="line">    protocol = TBinaryProtocol.TBinaryProtocol(transport)</div><div class="line">    client = Hbase.Client(protocol)</div><div class="line">    transport.open()</div><div class="line">    <span class="keyword">print</span> <span class="string">"Open connection success!"</span></div><div class="line"><span class="keyword">except</span> Exception,e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Get exception: "</span>,e</div><div class="line">    sys.exit(<span class="number">2</span>)</div><div class="line">\<span class="comment"># create table</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    tableName = <span class="string">"testThrfit"</span></div><div class="line">    colusername = ColumnDescriptor( name = <span class="string">'username:'</span>,maxVersions = <span class="number">1</span> )</div><div class="line">    colpass = ColumnDescriptor( name = <span class="string">'pass:'</span>,maxVersions = <span class="number">1</span> )</div><div class="line">    colage = ColumnDescriptor( name = <span class="string">'age:'</span>,maxVersions = <span class="number">1</span> )</div><div class="line">    colinfo = ColumnDescriptor( name = <span class="string">'info:'</span>,maxVersions = <span class="number">1</span> )</div><div class="line">    client.createTable(tableName, [colusername,colpass,colage,colinfo])</div><div class="line">    tables = client.getTableNames()</div><div class="line">    <span class="keyword">if</span> tableName <span class="keyword">in</span> tables:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Create table Success!"</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        returnRet = <span class="number">1</span></div><div class="line"><span class="keyword">except</span> Exception,e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"When create table, Get exception: "</span>,e</div><div class="line">    sys.exit(<span class="number">2</span>)</div><div class="line">\<span class="comment">#insert and get or scan number</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    rowKey = <span class="string">'rowTest'</span></div><div class="line">    testKey = <span class="string">'info:testName'</span></div><div class="line">    testValue = <span class="string">'testValue'</span></div><div class="line">    mutations = [Mutation(column=testKey,value=testValue)]</div><div class="line">    client.mutateRow(tableName,rowKey,mutations,<span class="keyword">None</span>)</div><div class="line">    result = client.getRow(tableName,rowKey,<span class="keyword">None</span>)</div><div class="line">    <span class="keyword">if</span> result:</div><div class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> result:</div><div class="line">            <span class="keyword">print</span> <span class="string">"get row:%s, and value is %s"</span>%(r.row,r.columns.get(testKey).value)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        returnRet = <span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Get from table Success!"</span></div><div class="line">    scan = TScan()</div><div class="line">    id = client.scannerOpenWithScan(tableName,scan,<span class="keyword">None</span>)</div><div class="line">    result = client.scannerGet(id)</div><div class="line">    <span class="keyword">while</span> result:</div><div class="line">        <span class="keyword">print</span> result</div><div class="line">        result = client.scannerGet(id)</div><div class="line">    <span class="keyword">print</span> <span class="string">"Scan from table Success!"</span></div><div class="line"><span class="keyword">except</span> Exception,e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"When insert,scan,get, Get exception: "</span>,e</div><div class="line">    sys.exit(<span class="number">2</span>)</div><div class="line">\<span class="comment">#delete table</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">if</span> client.isTableEnabled(tableName):</div><div class="line">       client.disableTable(tableName)</div><div class="line">       client.deleteTable(tableName)</div><div class="line">       <span class="keyword">if</span> tableName <span class="keyword">not</span> <span class="keyword">in</span> client.getTableNames():</div><div class="line">            <span class="keyword">print</span> <span class="string">"Drop table Success!"</span></div><div class="line">       <span class="keyword">else</span>:</div><div class="line">            returnRet = <span class="number">1</span></div><div class="line"><span class="keyword">except</span> Exception,e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"When delete, Get Excepiton: "</span>,e</div><div class="line">    sys.exit(<span class="number">2</span>)</div><div class="line">sys.exit(returnRet)</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/06/HBase基本操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/09/06/HBase基本操作/" itemprop="url">HBase基本操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-05T21:26:53-08:00">
                2014-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>更新表 经常用的更新表的操作主要包括四类： put、get、scan、delete </p>
<h1 id="put"><a href="#put" class="headerlink" title="put"></a>put</h1><p>put的操作主要是对表中单行的操作，这里要提示一句，HBase的表是按行加锁的，所以put的时候要避免同时操作同一行的行为发生。接下来用代码演示所有的put常用动作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putTable</span><span class="params">(String tableName)</span>  <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">	Configuration conf = HBaseConfiguration.create();</div><div class="line">	<span class="comment">//对于put的操作，所有的行为都是发生在Htable上的，对应的物理存储就是HStore,也就是一个StoreFile,这里初始化一个HTable的对象</span></div><div class="line">	HTable hTable = <span class="keyword">new</span> HTable(conf, tableName);</div><div class="line">	<span class="comment">//创建一个Put的对象，定义所有的Put行为</span></div><div class="line">	Put put = <span class="keyword">new</span> Put(Bytes.toBytes(<span class="string">"rowName"</span>));</div><div class="line">	<span class="comment">//接下来讲put对象的add操作，add操作可以用来增加或者更新某一行，主要有4个构造方法，详细内容可以自己查看，这里演示一种</span></div><div class="line">	put.add(Bytes.toBytes(<span class="string">"columnName"</span>), Bytes.toBytes(<span class="string">"key"</span>), Bytes.toBytes(<span class="string">"value"</span>));</div><div class="line">	put.add(Bytes.toBytes(<span class="string">"columnName"</span>), Bytes.toBytes(<span class="string">"key1"</span>), Bytes.toBytes(<span class="string">"value1"</span>));</div><div class="line">	<span class="comment">//这条add，会给列簇是columnName，key为key1的列更新其值为value2，在实际的物理存储中，实际是增加了一行</span></div><div class="line">	put.add(Bytes.toBytes(<span class="string">"columnName"</span>), Bytes.toBytes(<span class="string">"key1"</span>), Bytes.toBytes(<span class="string">"value2"</span>));</div><div class="line"></div><div class="line">	<span class="comment">//这里表示是否要写wal，对于要追求高效的插入数据又可以允许丢失少量数据，推介使用SKIP_WAL,如果对于严格要求不能丢失数据的用SYNC_WAL,</span></div><div class="line">	put.setDurability(Durability.FSYNC_WAL);</div><div class="line">	<span class="comment">//生效刚才put对象</span></div><div class="line">	hTable.put(put);</div><div class="line">	<span class="comment">//关闭对象</span></div><div class="line">	hTable.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="get"><a href="#get" class="headerlink" title="get"></a>get</h1><p>get主要的作用是获取指定rowkey的单行数据。对于一个get，获取到的对象均为一个Result的对象，一个Result的对象占用了一个RPC。一般来说，RPC的通信耗时，是系统主要的时间消耗，所以减少RPC的次数，将直接的提升性能。Get是一个获取单行结果的对象，与之对应的是Scan，是一个范围扫描的对象，所以要区分get和scan的不同功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">	Configuration conf= HBaseConfiguration.create();</div><div class="line">	<span class="comment">//初始胡table</span></div><div class="line">	HTable table = <span class="keyword">new</span> HTable(conf,tableName);</div><div class="line">  </div><div class="line">	<span class="comment">//指定要获取的row</span></div><div class="line">	Get get = <span class="keyword">new</span> Get(Bytes.toBytes(<span class="string">"newRow"</span>));</div><div class="line">	<span class="comment">//通过列簇名称和key值李获取指定的value</span></div><div class="line">	get.addColumn(Bytes.toBytes(<span class="string">"columnName"</span>), Bytes.toBytes(<span class="string">"key1"</span>));</div><div class="line">	<span class="comment">//过滤获取指定时间戳额值</span></div><div class="line">	get.setTimeStamp(<span class="number">1409886920751L</span>);</div><div class="line">	<span class="comment">//指定要获取的值的版本号，这里表示获取所有的版本号</span></div><div class="line">	get.setMaxVersions();</div><div class="line">	<span class="comment">//通过filter过滤减少返回结果，这里表示只返回一个结果，如果不过滤，对于有多个CF，或者有多个KV的，将会返回多个结果</span></div><div class="line">	get.setFilter(<span class="keyword">new</span> ColumnCountGetFilter(<span class="number">1</span>));</div><div class="line">	<span class="comment">//设置该值是否写到读缓存中，对于经常读的词，要设置为true，对于非热点，非经常读的，要设置为flase</span></div><div class="line">	get.setCacheBlocks(<span class="keyword">true</span>); </div><div class="line"></div><div class="line">	<span class="comment">//返回结果是一个result的对象，一个result的对象就表示一次的RPC，因此，如果想提升get的性能，降低RPC的次数是一个很沉重的话题</span></div><div class="line">	Result result = table.get(get);</div><div class="line"></div><div class="line">	<span class="comment">//解析一个Result的对象。要通过Cell对象来获取其具体的内容</span></div><div class="line">	<span class="keyword">for</span> (Cell cell: result.rawCells())&#123;</div><div class="line">		System.out.println(<span class="string">"Rowkey : "</span>+ Bytes.toString(result.getRow())+ <span class="string">" Familiy:Quilifier : "</span></div><div class="line">		<span class="comment">//通过cloneQualifier获取到列簇和key的值</span></div><div class="line">		\+ Bytes.toString(CellUtil.cloneQualifier(cell)) + <span class="string">" Value : "</span></div><div class="line">		<span class="comment">//通过cloneValue获取到结果中的value</span></div><div class="line">		\+ Bytes.toString(CellUtil.cloneValue(cell)));</div><div class="line">	&#125;</div><div class="line">	table.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h1><p> scan是一个可以返回特定的数据集合的方法。如Get中的描述，scan是获取多行数据的一个对象，通过scan可以批量查询，主要用在查询指定开始到结束行，或者指定时间范围，或者有某个filter特性的数据。具体的使用可以参考如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">	Configuration conf = HBaseConfiguration.create();</div><div class="line">	HTable table = <span class="keyword">new</span> HTable(conf, tableName);</div><div class="line">	<span class="comment">//创建一个scan对象的时候，不需要指定rowkey</span></div><div class="line">  	Scan scan = <span class="keyword">new</span> Scan();</div><div class="line">	<span class="comment">//设置查询的起始rowkey，在Hbase中，rowkey是按照字典排序的，所以这里指定的时候，是一个Byte的数据</span></div><div class="line">	scan.setStartRow(Bytes.toBytes(<span class="string">"key"</span>));</div><div class="line">	scan.setStopRow(Bytes.toBytes(<span class="string">"key"</span>));</div><div class="line"></div><div class="line">	<span class="comment">//这样可以获取到那些被打上了删除标签，但是没有被compaction删除的数据</span></div><div class="line">	scan.setRaw(<span class="keyword">true</span>);</div><div class="line">	<span class="comment">//获取的最大的结果条数，这个结果就死和一个result对象</span></div><div class="line">	scan.setMaxResultSize(<span class="number">1l</span>);</div><div class="line">	<span class="comment">//设置每个result中包含的行数</span></div><div class="line">	scan.setCaching(<span class="number">2</span>);</div><div class="line">	<span class="comment">//设置每个result中包含的列数</span></div><div class="line">	scan.setBatch(<span class="number">3</span>);</div><div class="line">	<span class="comment">//设置为逆序查找</span></div><div class="line">	scan.setReversed(<span class="keyword">true</span>);</div><div class="line">	<span class="comment">//设置一个过滤列表</span></div><div class="line">	FilterList filter = <span class="keyword">new</span> FilterList(FilterList.Operator.MUST_PASS_ALL);</div><div class="line">	<span class="comment">//设置一个filter的对象，过滤cf列簇中，qualifiter的等于0的所有的行</span></div><div class="line">	SingleColumnValueFilter filter1 = <span class="keyword">new</span> SingleColumnValueFilter(Bytes.toBytes(<span class="string">"cf"</span>), 		Bytes.toBytes(<span class="string">"qualifiter"</span>), CompareOp.EQUAL, Bytes.toBytes(<span class="string">"0"</span>));</div><div class="line"></div><div class="line">	<span class="comment">//为列表增加过滤</span></div><div class="line">	filter.addFilter(filter1);</div><div class="line">	<span class="comment">//为scan设置过滤器</span></div><div class="line">	scan.setFilter(filter);</div><div class="line">	ResultScanner rScanner = table.getScanner(scan);</div><div class="line">	<span class="comment">//这部分可以参考get部分的</span></div><div class="line">	<span class="keyword">for</span>(Result r : rScanner) &#123;</div><div class="line">		<span class="keyword">for</span>(Cell cell : r.rawCells()) &#123;</div><div class="line">			System.out.println(<span class="string">"Rowkey : "</span>+ Bytes.toString(r.getRow())+ <span class="string">" Familiy:Quilifier : "</span></div><div class="line">			\+ Bytes.toString(CellUtil.cloneQualifier(cell))+ <span class="string">" Value : "</span></div><div class="line">			\+ Bytes.toString(CellUtil.cloneValue(cell))</div><div class="line">			+ <span class="string">" Time : "</span>+ cell.getTimestamp());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	table.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h1><p>delete delete可以删除整个表（前面已经进行了分析），删除列簇、行、版本，用代码演示如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteTab</span> <span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">	Configuration conf = HBaseConfiguration.create();</div><div class="line">	HTable table = <span class="keyword">new</span> HTable(conf, tableName);</div><div class="line">	<span class="comment">//创建一个删除整行的delete对象并删除</span></div><div class="line">	Delete delete = <span class="keyword">new</span> Delete(Bytes.toBytes(<span class="string">"rowkey"</span>));</div><div class="line">	<span class="comment">//删除一个指定的列簇下指定的qualifier</span></div><div class="line">	delete.deleteColumn(Bytes.toBytes(<span class="string">"cf"</span>), Bytes.toBytes(<span class="string">"qualifier"</span>));</div><div class="line">  	<span class="comment">//和上面的类似，但是在这个删除中，会把所有的历史版本都删除</span></div><div class="line">	delete.deleteColumns(Bytes.toBytes(<span class="string">"cf"</span>), Bytes.toBytes(<span class="string">"qualifier"</span>));</div><div class="line">	<span class="comment">//也可以删除一个指定时间戳的数据</span></div><div class="line">	delete.deleteFamilyVersion(Bytes.toBytes(<span class="string">"cf"</span>), <span class="number">1405390959464L</span>);</div><div class="line">	table.delete(delete);</div><div class="line">	table.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要再强调一下，删除的时候，不会直接删除数据，而是先做一个删除的标记，在major compaction的时候，才会真正删除。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/04/HBase的一些元数据操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aiping.lap">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aiping.LAP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/09/04/HBase的一些元数据操作/" itemprop="url">HBase的一些元数据操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-03T20:26:52-08:00">
                2014-09-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>NameSpace 命名空间在很多地方都会用，主要其实是在指定一个规则，或者一个环境变量。在Hbase0.96后，增加了命名空间的概念。这个NameSpace是存储在ZK上的，类似与RDBMS里面的database的概念，主要似乎用来做权限管理和安全控制的。 </p>
<h2 id="收益"><a href="#收益" class="headerlink" title="收益"></a>收益</h2><p> 命名空间，是一个逻辑分组的概念，可见这个概念是为了多用户准备的，为的就是资源隔离。资源的隔离直接带来了几个特性： </p>
<p>1、资源在Hbase中，逻辑上可以用的资源是table，在物理上可以用的资源是region(当然还有更细力度的storeFile) </p>
<p>2、资源的分配主要是用来控制不同的namespace可以使用的资源</p>
<p>3、资源的存储 Hbase对于一个逻辑的资源table，如何能根据其所在的空间，被固定的分配到一个或者个多个regionserver上 </p>
<p>4、为不同的用户提供不同的资源 </p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>在系统中，有两个默认的命名空间，一个是hbase，是系统表.meta.使用的；另一个是default，主要是提供所有没有指定命名空间表用的。 </p>
<p>接下来分析一个自定义的命名空间的创建和使用</p>
<p>创建一个命名空间 最简单的办法是在hbase shell中创建，例如：create_namespace ‘lap’， </p>
<p>在创建完后，最直观的是在/hbase/data/下多了一个文件夹lap，同时，在zk的/hbase/namespace下也会多一个lap的节点。</p>
<p>在命名空间下创建一个表 create ‘lap:lapTable’,’info’。</p>
<p>删除一个命名空间 drop_namespace ‘lap’ </p>
<h3 id="使用namespace实现资源隔离"><a href="#使用namespace实现资源隔离" class="headerlink" title="使用namespace实现资源隔离"></a>使用namespace实现资源隔离</h3><p>每一个Table都隶属于一个NameSpace之下，每个NameSpace都有自己的Quota信息。例如Region的个数、hfile存储空间、甚至HBase之上的RPC的流量控制等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NamespaceDescriptor namespaceDescriptor = admin.getNamespaceDescriptor(tableName);</div><div class="line">namespaceDescriptor.setConfiguration(<span class="string">"hbase.namespace.quota.maxregion"</span>, <span class="string">"10"</span>);</div><div class="line">namespaceDescriptor.setConfiguration(<span class="string">"hbase.namespace.quota.maxtables"</span>, <span class="string">"10"</span>);</div></pre></td></tr></table></figure>
<p>这一部分在0.10中还未实现，相信在新的版本中，一定能给出好的解决方案。</p>
<h1 id="Table元数据操作"><a href="#Table元数据操作" class="headerlink" title="Table元数据操作"></a>Table元数据操作</h1><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>table的操作 对表的操作主要包括增、删、改、查，接下来用一段代码来展示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">voidcreateTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line"> 	Configuration conf = HBaseConfiguration.create();</div><div class="line">	HBaseAdmin admin = <span class="keyword">new</span> HBaseAdmin(conf);</div><div class="line">	<span class="comment">//创建一个新的命名空间</span></div><div class="line">	admin.createNamespace(NamespaceDescriptor.create(<span class="string">"lap"</span>).build());</div><div class="line">	<span class="comment">//申请新的表到该命名空间</span></div><div class="line">	HTableDescriptor tableDescriptor = <span class="keyword">new</span> HTableDescriptor(TableName.valueOf(<span class="string">"lap:"</span>+tableName));</div><div class="line">	<span class="comment">//设置表的属性，比如setDurability是设置acl的属性，而后一个直接设置所有的属性，当然这部分还包括列簇的属性</span></div><div class="line">	tableDescriptor.setDurability(Durability.SYNC_WAL);</div><div class="line">	tableDescriptor.setConfiguration(<span class="string">"BLOOMFILTER"</span>, <span class="string">"ROW"</span>);</div><div class="line"></div><div class="line">  	<span class="comment">//创建一个列簇并且加入到表中</span></div><div class="line">	HColumnDescriptor hColumnDescriptor = <span class="keyword">new</span> HcolumnDescriptor(<span class="string">"cf"</span>);</div><div class="line">	<span class="comment">//设置列簇的属性</span></div><div class="line">	hColumnDescriptor.setBloomFilterType(BloomType.ROW);</div><div class="line">	tableDescriptor.addFamily(hColumnDescriptor);</div><div class="line">	<span class="comment">//创建表</span></div><div class="line">	admin.createTable(tableDescriptor);</div><div class="line">	<span class="comment">//关闭链接</span></div><div class="line">	admin.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面可以看出来，表有两个Descriptor需要设置，一个是namespace的，一个是本身的。</p>
<p>表的命名空间的描述短时间内应该不会有很大的应用，因为不是很完善。而本身的属性会有很多需要设置的，比如：DURABILIT（设置写日志的方式）、MEMSTORE_FLUSHSIZE（memstore刷到硬盘上的大小）、BLOOMFILTER（roekey的头压缩）、DATA_BLOCK_ENCODING（数据部分的压缩）、TTL（过期时间）、IN_MEMORY（是否在内存中）等一系列的属性。这些属性会直接影响到表的查询和写入速度等特性，所以需要根据实际的数据设置。</p>
<h2 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">	Configuration conf = HBaseConfiguration.create();</div><div class="line">	HBaseAdmin admin = <span class="keyword">new</span> HBaseAdmin(conf);</div><div class="line">	<span class="keyword">if</span>(admin.tableExists(tableName))&#123;</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			<span class="comment">//必须要禁用表</span></div><div class="line">			admin.disableTable(tableName);</div><div class="line">			<span class="comment">//删除表</span></div><div class="line">			admin.deleteTable(tableName);</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	admin.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见，删除表的时候就比较简单了，直接用admin的对象，禁用表（这里必须禁用，防止别人正在操作该表，出现异常的问题），然后直接删除就可以了，在命令行是同样的道理。</p>
<h2 id="更新表"><a href="#更新表" class="headerlink" title="更新表"></a>更新表</h2><p>更新表分为两个部分，一部分是更新表的属性，一部分是更新表中的数据，所以这里要分两个部分讲： 对于更新表的属性，这里依旧要用表的描述符来修改，主要的操作包括，增加删除一个列簇，修改一个列簇的属性，具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alterTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">	Configuration conf = HBaseConfiguration.create();</div><div class="line">	HBaseAdmin admin= <span class="keyword">new</span> HBaseAdmin(conf);</div><div class="line">	<span class="keyword">if</span>(admin.tableExists(tableName))&#123;</div><div class="line">		<span class="comment">//和删除同样的道理，在更改表的描述符之前，必须先disable掉表</span></div><div class="line">		admin.disableTable(tableName);</div><div class="line">		<span class="comment">//获取当前表的描述符</span></div><div class="line">      	HTableDescriptor descriptor = admin.getTableDescriptor(Bytes.toBytes(tableName));</div><div class="line">		<span class="comment">//判断如果存在info的列簇，删除</span></div><div class="line">		<span class="keyword">if</span>(descriptor.hasFamily(Bytes.toBytes(<span class="string">"info"</span>)))&#123;</div><div class="line">			descriptor.removeFamily(Bytes.toBytes(<span class="string">"info"</span>));</div><div class="line">         &#125;</div><div class="line">		<span class="comment">//创建一个新的列簇</span></div><div class="line">		HColumnDescriptor hColumnDescriptor = <span class="keyword">new</span> HColumnDescriptor(Bytes.toBytes(<span class="string">"lapNew"</span>));</div><div class="line">		<span class="comment">//设置列簇的属性</span></div><div class="line">		hColumnDescriptor.setCompressionType(Algorithm.GZ);</div><div class="line">		<span class="comment">//为表增加一个新的列簇</span></div><div class="line">      	descriptor.addFamily(hColumnDescriptor);</div><div class="line">		<span class="comment">//获取到原先表中的列簇对象</span></div><div class="line">		HColumnDescriptor changeInfo = descriptor.getFamily(Bytes.toBytes(<span class="string">"clomun"</span>));</div><div class="line">		<span class="comment">//修改该对象的属性</span></div><div class="line">		changeInfo.setBlockCacheEnabled(<span class="keyword">true</span>);</div><div class="line">		<span class="comment">//让新的表描述符生效</span></div><div class="line">		admin.modifyTable(tableName, descriptor);</div><div class="line">		<span class="comment">//启用表</span></div><div class="line">		admin.enableTable(tableName);</div><div class="line">      	admin.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于表内容的修改，其实就是增加一行，因为Hbase的存储直接依赖与HDFS，而HDFS是只支持创建和追加的，不支持某一行的单独修改，所以Hbase对表的增删改的操作，事实上都是在对表增加，不同的是，如果是删除，会在表中删除字段标记为true，在表进行major compaction的时候，会删除该行。对表的修改实际是，增加一个新的时间戳或者新版本的行，在查询的时候，会按照时间戳排序，保证能查到最新的修改。鉴于上面这些，这里不会单独讲表内容的修改，会在接下来文章中详细将对与表内容的所有动作。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">aiping.lap</p>
              <p class="site-description motion-element" itemprop="description">aiping.liang s home</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aiping.lap</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
